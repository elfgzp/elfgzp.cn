<!-- 博文的布局-Layout -->
<!DOCTYPE html>
<html>
<head>
    <!-- 引入head标签 -->
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-sclable=0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="description" content="一个兴趣使然的程序员" />
<meta name="keywords" content="技术, Python, Vue, 后端开发，前端开发，日常" />
<link rel="stylesheet" href="/assets/css/bootstrap-toc.min.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/media.css">
<link rel="stylesheet" href="/assets/css/animate.min.css">
<link rel="stylesheet" href="/assets/css/pygments/pygments_default.css">
<link rel="stylesheet" href="/assets/css/github-markdown.css">

<!-- SNS-icon -->
<script src="//at.alicdn.com/t/font_856428_y9z6nq7zf5.js"></script>
<!-- share.css -->
<link rel="stylesheet" href="/assets/css/share.min.css">
<!-- font -->
<link rel="stylesheet" href="/assets/css/font.css">
<!-- <link href="https://fonts.googleapis.com/css?family=Kaushan+Script|Pacifico|Ubuntu|Roboto+Mono|Source+Sans+Pro" rel="stylesheet"> -->

<!-- Favicon -->
<link href="/assets/images/profile.jpeg" rel="shortcut icon" />
<link href="/assets/images/profile.jpeg" rel="apple-touch-icon-precomposed" />
<!-- Android Lolipop Theme Color -->
<!-- <meta name="theme-color" content="#1464FB"> -->
<title>使用 Consul 作为 Python 微服务的配置中心</title>
<!-- 百度统计 -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?db89c93fc4343f3fa42c3534a1aaad01";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!-- 谷歌分析 -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!--  Google ADS -->
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-9999308390903216",
    enable_page_level_ads: true
  });
</script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="/assets/js/bootstrap-toc.min.js"></script>
<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script src="/assets/js/main.js"></script>
<script>
if (window.netlifyIdentity) {
  window.netlifyIdentity.on("init", function (user) {
    if (!user) {
      window.netlifyIdentity.on("login", function () {
        document.location.href = "/admin/";
      });
    }
  });
}
</script>


    <!-- Android Lolipop Theme Color -->
<meta name="theme-color" content=" rgb(198, 44, 114) ">
    
</head>
<body>

<!-- 顶部锚点 -->
<a id="htmlup" name="htmlup"></a>
<!-- 引入博文顶部选项 -->

<header id="post-header" style="background-color:rgb(198, 44, 114);">
  <div class="top-center">
      <div class="logo">
          <a href="/" title="my awesome webtitle" style="color: white;"></a>
      </div>
      <nav class="top-nav">
          <ul>
              
                <li><a href="/" style="color: white;">首页</a></li>
              
                <li><a href="/tags.html" style="color: white;">标签</a></li>
              
                <li><a href="/timeline.html" style="color: white;">时间线</a></li>
              
                <li><a href="/about.html" style="color: white;">关于博主</a></li>
              
                <li><a href="/friendLink.html" style="color: white;">友情链接</a></li>
              
          </ul>
      </nav>
      <div id="site_search">
    <input type="text" id="search-input" placeholder="Search to jump ...">
    <ul id="results-container"></ul>
</div>
<script src="/assets/js/simple-jekyll-search.min.js"></script>
<script>
if (os.isAndroid || os.isPhone) {
  $('#site_search').hide()
} else {
  var sjs = SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: '/search.json'
  })}
</script>
      <div id="top-boot">
        <a href="javascript:;" id="boot1" style="display:block;" onclick="document.getElementById('boot-area').style.display='block';document.getElementById('boot1').style.display='none';document.getElementById('boot2').style.display='block';"><img src="/assets/images/boot_white.png" alt=""></a>
        <a href="javascript:;" id="boot2" style="display: none;" onclick="document.getElementById('boot-area').style.display='none';document.getElementById('boot1').style.display='block';document.getElementById('boot2').style.display='none';"><img src="/assets/images/boot_white.png" alt=""></a>
      </div>
  </div>

</header>


<!-- 引入移动下拉选项 -->
<div id="boot-area">
    <ul>
        
          <a href="/"><li>首页</li></a>
        
          <a href="/tags.html"><li>标签</li></a>
        
          <a href="/timeline.html"><li>时间线</li></a>
        
          <a href="/about.html"><li>关于博主</li></a>
        
          <a href="/friendLink.html"><li>友情链接</li></a>
        
    </ul>
</div>

<!-- 引入博文顶部样式 -->
<!-- 版本一 垃圾 -->
<!-- <div class="wow fadeIn top" data-wow-duration="3.5s" >
    <span class="wow fadeInUp" data-wow-delay="0.2s">使用 Consul 作为 Python 微服务的配置中心</span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span>
</div> -->

<!-- 版本二 可切换页面 -->

<div class="post-top" style="background-color:rgb(198, 44, 114);">
  <!-- 页面宽度大于800px -->
  <div class="left-area">
    
    <a href="/2019/01/09/django-experience-4-multidatabases.html" class="btn bounceInLeft animated" onmouseover="showLeft();this.style.color='rgb(198, 44, 114)';" onmouseout="goneLeft();this.style.color='rgba(0,0,0,.2)';"><</a>
    <div id="left-tab" style="display:none;"><span class="left-san"></span><span class="left-main" style="color:rgb(198, 44, 114);"><sapn class="main">Django 使用心得 （四）多数据库</sapn></span></div>
    
  </div>
  <div class="post-titlearea">
    <span class="wow fadeInUp" data-wow-delay="0.2s">使用 Consul 作为 Python 微服务的配置中心</span>
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span> -->
  </div>
  <div class="right-area">
    
    <a href="/2019/03/23/arts-week-1.html" class="btn bounceInRight self-animated" onmouseover="showRight();this.style.color='rgb(198, 44, 114)';" onmouseout="goneRight();this.style.color='rgba(0,0,0,.2)';">></a>
    <div id="right-tab" style="display:none;"><span class="right-san"></span><span class="right-main" style="color:rgb(198, 44, 114);"><sapn class="main">ARTS 第一周</sapn></span></div>
    
  </div>

  <!-- 页面宽度小于800px -->
  <div class="post-changearea">
    
    <a href="/2019/01/09/django-experience-4-multidatabases.html" class="leftchange" style="border-right: 1px solid rgb(198, 44, 114);border-bottom: 2px solid rgb(198, 44, 114);"><span>上一篇<br><br>Django 使用心得 （四）多数据库</span></a>
    
    
    <a href="/2019/03/23/arts-week-1.html" class="rightchange" style="border-left: 1px solid rgb(198, 44, 114);border-bottom: 2px solid rgb(198, 44, 114);"><span>下一篇<br><br>ARTS 第一周</span></a>
    
  </div>
</div>

<div class="toc">
    <span>Toc</span>
    <nav id="toc"></nav>
</div>
<div class="markdown-body fadeInUp animated">

    
    
    <div class="postpage-subtitle"
         style="border-left: 8px solid rgb(198, 44, 114); border-right: 8px solid rgb(198, 44, 114)">
        Python 配置中心
    </div>
    
    
    <img src="/assets/images/2019-03-11-consul-template-python-micro-service/og-image-439b4693.png" style="margin:auto;">
    <!-- 文章内容 -->
    <h1 id="使用-consul-作为-python-微服务的配置中心">使用 Consul 作为 Python 微服务的配置中心</h1>

<p>前半部分主要为 Consul 的一些介绍，若已经了解 Consul，可以直接跳转到：</p>

<p><a href="#使用-consul-作为-python-微服务的配置中心">使用 Consul 作为 Python 微服务的配置中心</a></p>

<h2 id="consul-简单介绍">Consul 简单介绍</h2>

<p><code class="highlighter-rouge">Consul</code> 是 HashiCorp 公司推出的开源工具，用于实现分布式系统的服务发现与配置。Consul 是分布式的、高可用的、 可横向扩展的。它具备以下特性:</p>

<ul>
  <li>服务发现: Consul 提供了通过 DNS 或者 HTTP 接口的方式来注册服务和发现服务。一些外部的服务通过 Consul 很容易的找到它所依赖的服务。</li>
  <li>健康检测: Consul 的 Client 提供了健康检查的机制，可以通过用来避免流量被转发到有故障的服务上。</li>
  <li><code class="highlighter-rouge">Key/Value</code> 存储: 应用程序可以根据自己的需要使用 Consul 提供的 Key/Value 存储。 Consul 提供了简单易用的 HTTP 接口，结合其他工具可以实现动态配置、功能标记、领袖选举等等功能。</li>
  <li>多数据中心: Consul 支持开箱即用的多数据中心. 这意味着用户不需要担心需要建立额外的抽象层让业务扩展到多个区域。</li>
</ul>

<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/consul-arch.png" alt="img" /></p>

<h3 id="consul-架构图解">Consul 架构图解</h3>

<p>Consul 集群间使用了 <code class="highlighter-rouge">Gossip</code> 协议通信和 raft 一致性算法。上面这张图涉及到了很多术语：</p>

<ul>
  <li>Gossip —— Gossip protocol 也叫 Epidemic Protocol （流行病协议），实际上它还有很多别名，比如：“流言算法”、“疫情传播算法”等。
这个协议的作用就像其名字表示的意思一样，非常容易理解，它的方式其实在我们日常生活中也很常见，比如电脑病毒的传播，森林大火，细胞扩散等等。</li>
  <li>Client —— 一个 Client 是一个转发所有 RPC 到 server 的代理。这个 client 是相对无状态的。client 唯一执行的后台活动是加入 LAN gossip 池。这有一个最低的资源开销并且仅消耗少量的网络带宽。</li>
  <li>Server —— 一个 server 是一个有一组扩展功能的代理，这些功能包括参与 Raft 选举，维护集群状态，响应 RPC 查询，与其他数据中心交互 WAN gossip 和转发查询给 leader 或者远程数据中心。</li>
  <li>DataCenter —— 虽然数据中心的定义是显而易见的，但是有一些细微的细节必须考虑。例如，在 EC2 中，多个可用区域被认为组成一个数据中心。我们定义数据中心为一个私有的，低延迟和高带宽的一个网络环境。这不包括访问公共网络，但是对于我们而言，同一个 EC2 中的多个可用区域可以被认为是一个数据中心的一部分。</li>
  <li>Consensus —— 一致性，使用 Consensus 来表明就 leader 选举和事务的顺序达成一致。为了以容错方式达成一致，一般有超过半数一致则可以认为整体一致。Consul 使用 Raft 实现一致性，进行 leader 选举，在 consul 中的使用 bootstrap 时，可以进行自选，其他 server 加入进来后 bootstrap 就可以取消。</li>
  <li>LAN Gossip —— 它包含所有位于同一个局域网或者数据中心的所有节点。</li>
  <li>WAN Gossip —— 它只包含 Server。这些 server 主要分布在不同的数据中心并且通常通过因特网或者广域网通信。</li>
  <li>RPC——远程过程调用。这是一个允许 client 请求 server 的请求/响应机制。</li>
</ul>

<h4 id="gossip-介绍">Gossip 介绍</h4>

<p>这里先简单介绍一下 <code class="highlighter-rouge">Gossip</code> 协议的执行过程：</p>

<p>Gossip 过程是由种子节点发起，当一个种子节点有状态需要更新到网络中的其他节点时，它会随机的选择周围几个节点散播消息，收到消息的节点也会重复该过程，直至最终网络中所有的节点都收到了消息。这个过程可能需要一定的时间，由于不能保证某个时刻所有节点都收到消息，但是理论上最终所有节点都会收到消息，因此它是一个最终一致性协议。</p>

<p>现在，我们通过一个具体的实例来深入体会一下 Gossip 传播的完整过程：
<strong>为了表述清楚，我们先做一些前提设定</strong>
1、Gossip 是周期性的散播消息，把周期限定为 1 秒
2、被感染节点随机选择 k 个邻接节点（fan-out）散播消息，这里把 fan-out 设置为 3，每次最多往 3 个节点散播。
3、每次散播消息都选择尚未发送过的节点进行散播
4、收到消息的节点不再往发送节点散播，比如 A -&gt; B，那么 B 进行散播的时候，不再发给 A。
这里一共有  16 个节点，节点 1 为初始被感染节点，通过 Gossip 过程，最终所有节点都被感染：</p>

<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/v2-575e785e7d03ad317e5bce4e36debb03_b.gif" alt="gossip" /></p>

<p><strong>注意要点：</strong></p>

<ul>
  <li>Consul Cluster 由部署和运行了 Consul Agent 的节点组成。在 Cluster 中有两种角色:Server 和 Client。</li>
  <li>Server 和 Client 的角色和 Consul Cluster 上运行的应用服务无关, 是基于 Consul 层面的一种角色划分.</li>
  <li>Consul Server: 用于维护 Consul Cluster 的状态信息。 官方建议是: 至少要运行 3 个或者 3 个以上的 Consul Server。 多个 server 之中需要选举一个 leader, 这个选举过程 Consul 基于 Raft 协议实现. 多个 Server 节点上的 Consul 数据信息保持强一致性。在局域网内与本地客户端通讯，通过广域网与其他数据中心通讯。</li>
  <li>Consul Client: 只维护自身的状态, 并将 HTTP 和 DNS 接口请求转发给服务端。</li>
</ul>

<h2 id="consul-与其他常见服务发现框架对比">Consul 与其他常见服务发现框架对比</h2>

<table>
  <thead>
    <tr>
      <th><strong>名称</strong></th>
      <th><strong>优点</strong></th>
      <th><strong>缺点</strong></th>
      <th><strong>接口</strong></th>
      <th><strong>一致性算法</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>zookeeper</td>
      <td>1.功能强大，不仅仅只是服务发现<br />2.提供 watcher 机制能实时获取服务提供者的状态<br />3.dubbo 等框架支持</td>
      <td>1.没有健康检查<br />2.需在服务中集成 sdk，复杂度高<br />3.不支持多数据中心</td>
      <td>sdk</td>
      <td>Paxos</td>
    </tr>
    <tr>
      <td>consul</td>
      <td>1.简单易用，不需要集成 sdk<br />2.自带健康检查<br />3.支持多数据中心<br />4.提供 web 管理界面</td>
      <td>1.不能实时获取服务信息的变化通知</td>
      <td>http/dns</td>
      <td>Raft</td>
    </tr>
    <tr>
      <td>etcd</td>
      <td>1.简单易用，不需要集成 sdk<br />2.可配置性强</td>
      <td>1.没有健康检查<br />2.需配合第三方工具一起完成服务发现<br />3.不支持多数据中心</td>
      <td>http</td>
      <td>Raft</td>
    </tr>
  </tbody>
</table>

<h2 id="consul-单机环境部署">Consul 单机环境部署</h2>

<p>首先 <code class="highlighter-rouge">clone</code> 本项目到本地：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone git@github.com:elfgzp/python-consul-demo.git
</code></pre></div></div>

<p>Consul 单机部署所需要用到的文件如下：</p>

<ul>
  <li>docker-compose-server.yml —— Consul Server <code class="highlighter-rouge">docker-compose</code> 配置文件</li>
  <li>docker-compose-client.yml —— Consul Client <code class="highlighter-rouge">docker-compose</code> 配置文件</li>
</ul>

<p>可以看到两个 docker-compose 文件均暴露了 8 个端口。根据官方文档，这些端口的作用如下：</p>

<blockquote>
  <h2 id="ports-used">Ports Used</h2>

  <p>Consul requires up to 6 different ports to work properly, some on TCP, UDP, or both protocols. Below we document the requirements for each port.</p>

  <ul>
    <li>Server RPC (Default 8300). This is used by servers to handle incoming requests from other agents. TCP only.</li>
    <li>Serf LAN (Default 8301). This is used to handle gossip in the LAN. Required by all agents. TCP and UDP.</li>
    <li>Serf WAN (Default 8302). This is used by servers to gossip over the WAN, to other servers. TCP and UDP. As of Consul 0.8 the WAN join flooding feature requires the Serf WAN port (TCP/UDP) to be listening on both WAN and LAN interfaces. See also: <a href="https://github.com/hashicorp/consul/blob/master/CHANGELOG.md#080-april-5-2017">Consul 0.8.0 CHANGELOG</a> and <a href="https://github.com/hashicorp/consul/issues/3058">GH-3058</a></li>
    <li>HTTP API (Default 8500). This is used by clients to talk to the HTTP API. TCP only.</li>
    <li>DNS Interface (Default 8600). Used to resolve DNS queries. TCP and UDP.</li>
  </ul>
</blockquote>

<p>还有一些配置参数这里就不一一介绍了，<a href="https://www.consul.io/docs/agent/options.html">官方文档</a>写的非常详细。</p>

<h3 id="consul-server-部署">Consul Server 部署</h3>

<p>首先需要给环境变量 <code class="highlighter-rouge">CONSUL_SERVER_IP_ADDR</code> 赋值，若为 ECS 则为 ECS 的外网 IP，这里也是演示在 ECS 部署。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">CONSUL_SERVER_IP_ADDR</span><span class="o">={</span>YOUR_IP_ADDR<span class="o">}</span>
</code></pre></div></div>

<p>然后运行，这里没有使用 <code class="highlighter-rouge">-d</code> 参数，方便查看日志：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-server.yml up
</code></pre></div></div>
<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/WX20190311-110827.png" alt="docker-compose -f docker-compose-server.yml up" /></p>

<h3 id="consul-client-部署">Consul Client 部署</h3>

<p>运行 docker-compose 前，设置  <code class="highlighter-rouge">CONSUL_SERVER_HOST</code>  环境变量：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">CONSUL_SERVER_HOST</span><span class="o">={</span>YOUR_SERVER_HOST<span class="o">}</span>
</code></pre></div></div>

<p>然后运行：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker-compose <span class="nt">-f</span> docker-compose-client.yml up
</code></pre></div></div>

<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/WX20190311-111641.png" alt="img4" /></p>

<p>部署完成后可以通过 Consul UI 的 <code class="highlighter-rouge">Nodes</code> 看到两个 <code class="highlighter-rouge">Healthy Nodes</code>：</p>

<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/WX20190311-111828@2x.png" alt="img4" /></p>

<p>也可以在部署好 Consul Client 的宿主机上运行：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>consul members
</code></pre></div></div>

<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/WX20190311-112105.png" alt="img5" /></p>

<p><strong>这里要注意</strong>：</p>

<p>在查看了 <code class="highlighter-rouge">Consul</code> 仓库的 <a href="https://github.com/hashicorp/consul/issues/1720">issue#1720</a> 发现，Consul 提供的 Web UI 并没有提供 Auth 功能，所以可能要依靠第三方服务来实现，评论中也有提到：</p>

<blockquote>
  <h3 id="highlyunavailable-commented-on-17-feb-2016"><strong>highlyunavailable</strong> commented <a href="https://github.com/hashicorp/consul/issues/1720#issuecomment-184845561">on 17 Feb 2016</a></h3>

  <p>When I ran a Consul Web UI I just used nginx and <a href="https://github.com/bitly/oauth2_proxy">https://github.com/bitly/oauth2_proxy</a> to provide authentication.</p>
</blockquote>

<p>但是 HTTP 接口的权限，可以通过 Consul ACL 来控制，这是后话。</p>

<h2 id="使用-consul-作为-python-微服务的配置中心-1">使用 Consul 作为 Python 微服务的配置中心</h2>

<p>Consul 作为数据中心，提供了 <code class="highlighter-rouge">k/v</code> 存储的功能，我们可以利用这个功能为 Python 微服务提供配置中心。</p>

<p>Consul 提供了 HTTP 接口，我们可以从他的接口获取数据，当然我们不用自己去实现，<a href="https://python-consul.readthedocs.io/en/latest/">python-consul</a> 已经帮我们造好了轮子。</p>

<p>而且官方文档非常贴心，已经贴好了 Python 常用框架的一些 demo 代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">IOLoop</span>
<span class="kn">from</span> <span class="nn">tornado.gen</span> <span class="kn">import</span> <span class="n">coroutine</span>
<span class="kn">from</span> <span class="nn">consul.base</span> <span class="kn">import</span> <span class="n">Timeout</span>
<span class="kn">from</span> <span class="nn">consul.tornado</span> <span class="kn">import</span> <span class="n">Consul</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">foo</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">loop</span><span class="p">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">watch</span><span class="p">)</span>

    <span class="o">@</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Consul</span><span class="p">()</span>

        <span class="c1"># asynchronously poll for updates
</span>        <span class="n">index</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">c</span><span class="p">.</span><span class="n">kv</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'foo'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">foo</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'Value'</span><span class="p">]</span>
            <span class="k">except</span> <span class="n">Timeout</span><span class="p">:</span>
                <span class="c1"># gracefully handle request timeout
</span>                <span class="k">pass</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">IOLoop</span><span class="p">.</span><span class="n">instance</span><span class="p">()</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
    <span class="n">loop</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="结合-consul-template-用解藕的方式去配置微服务">结合 consul-template 用解藕的方式去配置微服务</h3>

<blockquote>
  <p>Consul Template 提供一个方便的方式从 Consul 获取数据通过 consul-template 的后台程序保存到文件系统。<br />
这个后台进程监控 Consul 示例的变化并更新任意数量的模板到文件系统.作为一个附件功能,模板更新完成后 consul-template 可以运行任何命令.可以查看示例部分看这个功能将会对哪些应用场景产生帮助。</p>
</blockquote>

<p>首先需要在 Consul Client 所在的宿主机安装 <code class="highlighter-rouge">consul-template</code>，由于 Demo 宿主机环境为 Mac OS，所以可以直接用 <code class="highlighter-rouge">HomeBrew</code> 进行安装。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>brew <span class="nb">install </span>consul-template
</code></pre></div></div>

<p>安装完成后进入仓库的 <code class="highlighter-rouge">python-web-service</code> 路径，这是一个用 tornado 写的简单的 Web 服务。执行如下命令：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>python-web-service <span class="o">&amp;&amp;</span> docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p>等待命令运行完成，服务启动后，访问 <code class="highlighter-rouge">localhost:8888</code> 可以看到返回内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8888
Hello World
</code></pre></div></div>

<p>然后我们回到仓库路径，进入 <code class="highlighter-rouge">consul-template</code> 目录，该目录主要包含以下两个文件：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd</span> ../consul-template
<span class="nv">$ </span>tree
<span class="nb">.</span>
├── config.hcl <span class="c"># consul-template 配置文件</span>
└── config.py.ctmpl <span class="c"># python-web-service 配置模版文件</span>
</code></pre></div></div>

<p>查看一下 <code class="highlighter-rouge">config.hcl</code> 文件的内容：</p>

<div class="language-hcl highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">consul</span> <span class="p">{</span>
  <span class="nx">address</span> <span class="p">=</span> <span class="s2">"127.0.0.1:8500"</span>

<span class="p">}</span>

<span class="nx">template</span> <span class="p">{</span>

  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./config.py.ctmpl"</span>
  <span class="nx">destination</span> <span class="p">=</span> <span class="s2">"../python-web-service/config.py"</span>
  <span class="nx">command</span> <span class="p">=</span> <span class="s2">"docker restart python-web-service_python-web-service_1"</span>

<span class="p">}</span>
</code></pre></div></div>

<p>先介绍一下 <code class="highlighter-rouge">*.hcl</code> 配置文件，这个是 Consul 中非常常见的配置文件格式，也是 <code class="highlighter-rouge">HashiCorp</code> 下的产品所用的主要配置文件格式。配置文件中包含了 <code class="highlighter-rouge">4</code> 个重要的参数：</p>

<ul>
  <li><code class="highlighter-rouge">address</code> —— Consul Client 的访问地址和端口</li>
  <li><code class="highlighter-rouge">source</code> —— 需要配置的服务的配置文件模板</li>
  <li><code class="highlighter-rouge">destination</code> —— 配置文件渲染后输出的路径</li>
  <li><code class="highlighter-rouge">command</code> —— 当配置变更后，需要执行的命令</li>
</ul>

<p>再来看看模板文件 <code class="highlighter-rouge">config.py.ctmpl</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8 -*-
</span><span class="n">__author__</span> <span class="o">=</span> <span class="s">'gzp'</span>

<span class="n">GREETING</span> <span class="o">=</span> <span class="s">'{{ keyOrDefault "python-web-service/greeting" "Hello World" }}'</span>
</code></pre></div></div>

<p>模版文件的格式非常类似 <code class="highlighter-rouge">Jinja2</code> 的语法，这里的意思获取 <code class="highlighter-rouge">key</code> 为 <code class="highlighter-rouge">python-web-service/greeting</code> 下的值，默认值为 <code class="highlighter-rouge">HelloWorld</code>。</p>

<p>接下来运行命令使 <code class="highlighter-rouge">consul-template</code> 生效：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>consul-template <span class="nt">-config</span> config.hcl
</code></pre></div></div>

<p>我们可以访问 Consul Web UI 的 <code class="highlighter-rouge">Key/Value</code> 来修改我们的值：</p>

<p><img src="https://github.com/elfgzp/python-consul-demo/raw/master/docs/assets/images/WX20190311-115350@2x.png" alt="img6" /></p>

<p>将 <code class="highlighter-rouge">Hello World</code> 修改为 <code class="highlighter-rouge">Hello Consul</code>，配置可能没有立即生效，若看到 <code class="highlighter-rouge">consul-template</code> 输出，则代表配置生效，服务以及重启：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>consul-template <span class="nt">-config</span> config.hcl
python-web-service_python-web-service_1
</code></pre></div></div>

<p>然后再次访问一下 web 服务：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl http://localhost:8888
Hello Consul
</code></pre></div></div>

<p>可以看到配置已经生效。</p>

<h2 id="参考文献">参考文献</h2>

<blockquote>
  <p><a href="https://www.hi-linux.com/posts/6132.html">Consul 入门 - 运维之美</a></p>

  <p><a href="https://zhuanlan.zhihu.com/p/41228196">P2P 网络核心技术：Gossip 协议</a></p>

  <p><a href="https://www.servercoder.com/2018/03/30/consul-vs-zookeeper-etcd/">服务发现框架选型，Consul 还是 Zookeeper 还是 etcd</a></p>
</blockquote>


    <!-- 引入share模块 -->
    
  <div class="social-share-wrapper">
    <div class="social-share"></div>
  </div>


<!-- share.js -->
<script src="/assets/js/social-share.min.js"></script>
<script>
  socialShare('.social-share', {
    sites: [
      
        'qq'
        ,
        
      
        'wechat'
        ,
        
      
        'weibo'
        ,
        
      
        'twitter'
        ,
        
      
        'facebook'
        
      
    ],
    wechatQrcodeTitle: "分享到微信朋友圈",
    wechatQrcodeHelper: '期待在朋友圈见到这篇文章'
  });
</script>

</div>

<!-- 底部锚点 -->
<a id="htmldown" name="htmldown"></a>
<!-- 引入评论模块 -->



    <section class="post-footer-item comment">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MDA4OS8xNjYxNg=="></div>
    </section>

    <!-- 来必力City版安装代码 -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- City版安装代码已完成 -->





<!-- 引入goto模块 -->
<div class="bounceInRight animated go">
  <a title="顶部切换页面" class="gototop" href="#htmlup" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Top
    </div>
  </a>
  <a title="底部有livere评论哦" class="gotobottom" href="#htmldown" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Foot
    </div>
  </a>
</div>

<!-- 引入页面底部模块 -->
<footer id="bottom">
  <br>
  <span>Gzp的博客 ©
  
  
    2018
    -
  
  2020
  <a href="http://www.beian.miit.gov.cn">粤ICP备16038504号-1</a>
  <br>
  Powered by <a href="https://www.jekyll.com.cn/">Jekyll</a> | <a href="https://github.com/xukimseven/HardCandy-Jekyll">HardCandy-Jekyll</a></span>
</footer>


<!-- 引用wow.js的动画效果 -->
<script src="/assets/js/wow.js"></script>
<script>
var wow = new WOW({
  boxClass: 'wow',
  animateClass: 'animated',
  // offset: 600,
  mobile: true,
  live: true
})
wow.init()
</script>
<!-- 页面刷新回到顶部 -->
<script>
window.onbeforeunload = function () {
  //刷新后页面自动回到顶部
  document.documentElement.scrollTop = 0  //ie下
  document.body.scrollTop = 0  //非ie
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>

<link rel="stylesheet" href="/assets/css/bootstrap-toc.min.css">
<script src="/assets/js/bootstrap-toc.min.js"></script>
<script>
var navSelector = '#toc'
var $myNav = $(navSelector)

if (os.isAndroid || os.isPhone) {
  $myNav.parent().hide()
} else {
  $(function () {
    Toc.init($myNav)
    $('body').scrollspy({
      target: navSelector
    })
  })
}
</script>
<style type="text/css">

    nav[data-toggle=toc] .nav>li>a:focus,nav[data-toggle=toc] .nav>li>a:hover {
        padding-left: 19px;
        color: rgb(198, 44, 114);
        text-decoration: none;
        background-color: transparent;
        border-left: 1px solid rgb(198, 44, 114);
    }

    nav[data-toggle=toc] .nav-link.active, nav[data-toggle=toc] .nav-link.active:focus, nav[data-toggle=toc] .nav-link.active:hover {
        padding-left: 18px;
        font-weight: 700;
        color: rgb(198, 44, 114);
        background-color: transparent;
        border-left: 2px solid rgb(198, 44, 114);
    }

</style>
    <!-- Google Analytics -->
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-126817847-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-126817847-1');
</script>
</body>
</html>
