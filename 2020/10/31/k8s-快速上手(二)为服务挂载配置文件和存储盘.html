<!-- 博文的布局-Layout -->
<!DOCTYPE html>
<html>
<head>
    <!-- 引入head标签 -->
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-sclable=0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="description" content="一个兴趣使然的程序员" />
<meta name="keywords" content="技术, Python, Vue, 后端开发，前端开发，日常" />
<link rel="stylesheet" href="/assets/css/bootstrap-toc.min.css">
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/media.css">
<link rel="stylesheet" href="/assets/css/animate.min.css">
<link rel="stylesheet" href="/assets/css/pygments/pygments_default.css">
<link rel="stylesheet" href="/assets/css/github-markdown.css">

<!-- SNS-icon -->
<script src="//at.alicdn.com/t/font_856428_y9z6nq7zf5.js"></script>
<!-- share.css -->
<link rel="stylesheet" href="/assets/css/share.min.css">
<!-- font -->
<link rel="stylesheet" href="/assets/css/font.css">
<!-- <link href="https://fonts.googleapis.com/css?family=Kaushan+Script|Pacifico|Ubuntu|Roboto+Mono|Source+Sans+Pro" rel="stylesheet"> -->

<!-- Favicon -->
<link href="/assets/images/profile.jpeg" rel="shortcut icon" />
<link href="/assets/images/profile.jpeg" rel="apple-touch-icon-precomposed" />
<!-- Android Lolipop Theme Color -->
<!-- <meta name="theme-color" content="#1464FB"> -->
<title>K8s 快速上手 (二) 为服务挂载配置文件和存储盘</title>
<!-- 百度统计 -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?db89c93fc4343f3fa42c3534a1aaad01";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!-- 谷歌分析 -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!--  Google ADS -->
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-9999308390903216",
    enable_page_level_ads: true
  });
</script>

<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="/assets/js/bootstrap-toc.min.js"></script>
<!-- Mathjax Support -->
<script type="text/javascript" async
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script src="/assets/js/main.js"></script>
<script>
if (window.netlifyIdentity) {
  window.netlifyIdentity.on("init", function (user) {
    if (!user) {
      window.netlifyIdentity.on("login", function () {
        document.location.href = "/admin/";
      });
    }
  });
}
</script>


    <!-- Android Lolipop Theme Color -->
<meta name="theme-color" content=" rgb(49, 106, 223) ">
    
</head>
<body>

<!-- 顶部锚点 -->
<a id="htmlup" name="htmlup"></a>
<!-- 引入博文顶部选项 -->

<header id="post-header" style="background-color:rgb(49, 106, 223);">
  <div class="top-center">
      <div class="logo">
          <a href="/" title="my awesome webtitle" style="color: white;"></a>
      </div>
      <nav class="top-nav">
          <ul>
              
                <li><a href="/" style="color: white;">首页</a></li>
              
                <li><a href="/tags.html" style="color: white;">标签</a></li>
              
                <li><a href="/timeline.html" style="color: white;">时间线</a></li>
              
                <li><a href="/about.html" style="color: white;">关于博主</a></li>
              
                <li><a href="/friendLink.html" style="color: white;">友情链接</a></li>
              
          </ul>
      </nav>
      <div id="site_search">
    <input type="text" id="search-input" placeholder="Search to jump ...">
    <ul id="results-container"></ul>
</div>
<script src="/assets/js/simple-jekyll-search.min.js"></script>
<script>
if (os.isAndroid || os.isPhone) {
  $('#site_search').hide()
} else {
  var sjs = SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: '/search.json'
  })}
</script>
      <div id="top-boot">
        <a href="javascript:;" id="boot1" style="display:block;" onclick="document.getElementById('boot-area').style.display='block';document.getElementById('boot1').style.display='none';document.getElementById('boot2').style.display='block';"><img src="/assets/images/boot_white.png" alt=""></a>
        <a href="javascript:;" id="boot2" style="display: none;" onclick="document.getElementById('boot-area').style.display='none';document.getElementById('boot1').style.display='block';document.getElementById('boot2').style.display='none';"><img src="/assets/images/boot_white.png" alt=""></a>
      </div>
  </div>

</header>


<!-- 引入移动下拉选项 -->
<div id="boot-area">
    <ul>
        
          <a href="/"><li>首页</li></a>
        
          <a href="/tags.html"><li>标签</li></a>
        
          <a href="/timeline.html"><li>时间线</li></a>
        
          <a href="/about.html"><li>关于博主</li></a>
        
          <a href="/friendLink.html"><li>友情链接</li></a>
        
    </ul>
</div>

<!-- 引入博文顶部样式 -->
<!-- 版本一 垃圾 -->
<!-- <div class="wow fadeIn top" data-wow-duration="3.5s" >
    <span class="wow fadeInUp" data-wow-delay="0.2s">K8s 快速上手 (二) 为服务挂载配置文件和存储盘</span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span>
</div> -->

<!-- 版本二 可切换页面 -->

<div class="post-top" style="background-color:rgb(49, 106, 223);">
  <!-- 页面宽度大于800px -->
  <div class="left-area">
    
    <a href="/2020/10/25/k8s-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B(%E4%B8%80)%E5%9C%A8%E4%BA%91%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%83%A8%E7%BD%B2%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1.html" class="btn bounceInLeft animated" onmouseover="showLeft();this.style.color='rgb(49, 106, 223)';" onmouseout="goneLeft();this.style.color='rgba(0,0,0,.2)';"><</a>
    <div id="left-tab" style="display:none;"><span class="left-san"></span><span class="left-main" style="color:rgb(49, 106, 223);"><sapn class="main">K8s 快速上手（一) 在云主机上部署我的服务</sapn></span></div>
    
  </div>
  <div class="post-titlearea">
    <span class="wow fadeInUp" data-wow-delay="0.2s">K8s 快速上手 (二) 为服务挂载配置文件和存储盘</span>
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span> -->
  </div>
  <div class="right-area">
    
    <a href="javascript:;" class="btn bounceInRight self-animated" onmouseover="showRight();this.style.color='rgb(49, 106, 223)';" onmouseout="goneRight();this.style.color='rgba(0,0,0,.2)';">></a>
    <div id="right-tab" style="display:none;"><span class="right-san"></span><span class="right-main" style="color:rgb(49, 106, 223);"><sapn class="main">没有下一页咯</sapn></span></div>
    
  </div>

  <!-- 页面宽度小于800px -->
  <div class="post-changearea">
    
    <a href="/2020/10/25/k8s-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B(%E4%B8%80)%E5%9C%A8%E4%BA%91%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%83%A8%E7%BD%B2%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1.html" class="leftchange" style="border-right: 1px solid rgb(49, 106, 223);border-bottom: 2px solid rgb(49, 106, 223);"><span>上一篇<br><br>K8s 快速上手（一) 在云主机上部署我的服务</span></a>
    
    
    <a href="javascript:;" class="rightchange" style="border-left: 1px solid rgb(49, 106, 223);border-bottom: 2px solid rgb(49, 106, 223);"><span><br>没有下一篇咯</span></a>
    
  </div>
</div>

<div class="toc">
    <span>Toc</span>
    <nav id="toc"></nav>
</div>
<div class="markdown-body fadeInUp animated">

    
    
    <div class="postpage-subtitle"
         style="border-left: 8px solid rgb(49, 106, 223); border-right: 8px solid rgb(49, 106, 223)">
        为部署在 K8s(k3s) 的服务挂载配置文件和存储盘
    </div>
    
    
    <img src="/assets/uploads/kuberneteshero.jpg" style="margin:auto;">
    <!-- 文章内容 -->
    <p>上一篇文章 <a href="https://elfgzp.cn/2020/10/25/k8s-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B(%E4%B8%80)%E5%9C%A8%E4%BA%91%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%83%A8%E7%BD%B2%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1.html">「K8s 快速上手（一) 在云主机上部署我的服务」</a> 介绍了如何快在云主机上快速的搭建 K3s，并且将一个服务部署到 K3s 中。</p>

<p>这篇文章将介绍如何给部署的服务挂载配置文件或存储盘。</p>

<h2 id="为服务挂载配置文件">为服务挂载配置文件</h2>

<p>我们同样以上一篇文章的 <code class="highlighter-rouge">nginx.yaml</code> 为例，上一篇的 <code class="highlighter-rouge">nginx.yaml</code> 文件内容如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:latest</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">type</span><span class="pi">:</span>  <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30080</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
</code></pre></div></div>

<p>我们想将一个 nginx 配置文件挂载到 <code class="highlighter-rouge">/etc/conf.d</code> 目录下，我们这次需要使用到一个 K8s 资源 <code class="highlighter-rouge">ConfigMap</code>。</p>

<p>使用 <code class="highlighter-rouge">ConfigMap</code> 能更加方便的管理配置文件并且也能以非常便捷的方式挂载到服务容器中。接下来我就来介绍一下如何使用。</p>

<p>假设我有一个 <code class="highlighter-rouge">index.conf</code> 的配置文件和一个 <code class="highlighter-rouge">index.html</code> 的文件分别想挂载到 nginx 容器的 <code class="highlighter-rouge">/etc/conf.d/default.conf</code> 和 <code class="highlighter-rouge">/opt/index.html</code> 目录下。这里的 index.html 只是用于演示，正常的生产环境的前端发布还是将前端文件一起 build 在镜像中才是最佳实践。</p>

<p><code class="highlighter-rouge">index.conf</code> 的文件内容如下：</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">server</span> {
  <span class="n">listen</span>       <span class="m">80</span>;
  <span class="n">server_name</span>  <span class="err">_</span>;

  <span class="n">location</span> / {
    <span class="n">root</span>    /<span class="n">opt</span>;
    <span class="n">index</span>  <span class="n">index</span>.<span class="n">html</span>;
  }
}
</code></pre></div></div>

<p><code class="highlighter-rouge">index.html</code> 的文件内容如下：</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello K8s<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>要挂载这两个文件，首先第一步我们需要创建一个 <code class="highlighter-rouge">ConfigMap</code> 资源，我们直接将这个资源也放在 <code class="highlighter-rouge">nginx.yaml</code> 文件中，在实际使用中可以按照需要拆分资源到不同的 <code class="highlighter-rouge">YAML</code> 文件。<code class="highlighter-rouge">ConfigMap</code> 资源的定义如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">index.conf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">server {</span>
      <span class="s">listen       80;</span>
      <span class="s">server_name  _;</span>

      <span class="s">location / {</span>
        <span class="s">root    /opt;</span>
        <span class="s">index  index.html;</span>
      <span class="s">}</span>
    <span class="s">}</span>
  <span class="s">index.html</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">&lt;!DOCTYPE html&gt;</span>
    <span class="s">&lt;html lang="en"&gt;</span>
    <span class="s">&lt;body&gt;</span>
        <span class="s">&lt;h1&gt;Hello K8s&lt;/h1&gt;</span>
    <span class="s">&lt;/body&gt;</span>
    <span class="s">&lt;/html&gt;</span>
</code></pre></div></div>

<p>然后修改我们定义的 <code class="highlighter-rouge">Deployment</code> 资源，增加 <code class="highlighter-rouge">spec.volumes</code> 和 <code class="highlighter-rouge">spec.containers[0].volumeMounts</code> 字段，修改后的 <code class="highlighter-rouge">Deployment</code> 如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:latest</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/nginx/conf.d/default.conf</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">index.conf</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/opt/index.html</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">index.html</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
</code></pre></div></div>

<p>修改完成后使用应用一下 <code class="highlighter-rouge">nginx.yaml</code> 文件的变更：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ kubectl apply <span class="nt">-f</span> nginx.yaml 
namespace/nginx-1 created
configmap/nginx-conf created
deployment.apps/nginx created
service/nginx created
</code></pre></div></div>

<p>通过 <code class="highlighter-rouge">kubectl get pod -n nginx-1</code> 查看 <code class="highlighter-rouge">nginx</code> 是否部署完成，部署完成后通过浏览器访问就可以看到效果了。</p>

<p><img src="/assets/uploads/0b6e76e8-8450-4f89-bc0f-c4702f6987ff.png" alt="img1" title="img1" /></p>

<p>我们可以通过 <code class="highlighter-rouge">kubectl logs -n nginx-1 {nginx Pod 的名字} -f</code> 观察 <code class="highlighter-rouge">nginx</code> 的日志</p>

<p>假设我们要修改 <code class="highlighter-rouge">ConfigMap</code>，但是在修改后不会直接生效，我们需要重新部署 <code class="highlighter-rouge">nginx</code>，可以通过以下命令重新部署 <code class="highlighter-rouge">nginx</code>：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl rollout restart deployment <span class="nt">-n</span> nginx-1 nginx
</code></pre></div></div>

<h2 id="为服务挂载存储盘">为服务挂载存储盘</h2>

<p>有时候我们需要通过挂载存储盘将服务中的数据持久化，例如：Mysql。在生产环境中，我们一般不应该直接将机器的存储路径挂载到服务容器中，因为这样就无法做到快速扩容和缩容了，在生产环境中一般会使用云厂商提供的存储盘进行挂载。</p>

<p>但是我们在平常使用并不会购买云厂商的存储盘，所以我这里就以挂载到宿主机的存储路径作为演示。</p>

<p>假设我们需要把容器中的 <code class="highlighter-rouge">/var/log/nginx/access.log</code> 和 <code class="highlighter-rouge">/var/log/nginx/error.log</code> 挂载到宿主机的目录下。首先我们先修改一下 <code class="highlighter-rouge">ConfigMap</code> 文件，将容器的日志打到这两个文件。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="s">index.conf</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">server {</span>
      <span class="s">listen       80;</span>
      <span class="s">server_name  _;</span>

      <span class="s">access_log  /var/log/nginx/access.log  main;</span>
      <span class="s">error_log  /var/log/nginx/error.log warn;</span>

      <span class="s">location / {</span>
        <span class="s">root    /opt;</span>
        <span class="s">index  index.html;</span>
      <span class="s">}</span>
    <span class="s">}</span>
  <span class="s">index.html</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">&lt;!DOCTYPE html&gt;</span>
    <span class="s">&lt;html lang="en"&gt;</span>
    <span class="s">&lt;body&gt;</span>
        <span class="s">&lt;h1&gt;Hello K8s&lt;/h1&gt;</span>
    <span class="s">&lt;/body&gt;</span>
    <span class="s">&lt;/html&gt;</span>
</code></pre></div></div>

<p>然后我们需要定义两个 K8s 资源，他们分别是：</p>

<ul>
  <li>
    <p><strong>PersistentVolume</strong> （持久卷，简称PV）是集群内，由管理员提供的网络存储的一部分。就像集群中的计算节点一样，PV也是集群中的一种资源。</p>
  </li>
  <li>
    <p><strong>PersistentVolumeClaim</strong> 持久卷声明，简称 PVC）是用户的一种存储请求。它和 Pod 类似，Pod 消耗 Node 资源，而 PVC 消耗PV资源。</p>
  </li>
</ul>

<p><code class="highlighter-rouge">PVC</code> 可以理解为持久化存储的“接口”，它提供了对某种持久化存储的描述，但不提供具体的实现；而这个持久化存储的实现部分则由 <code class="highlighter-rouge">PV</code> 负责完成。</p>

<p>我们先为 nginx 定义这两个资源，他们的定义如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolume</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-pv</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">manual</span>
  <span class="na">capacity</span><span class="pi">:</span>
    <span class="na">storage</span><span class="pi">:</span> <span class="s">2Gi</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">hostPath</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/opt/nginx"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PersistentVolumeClaim</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-pvc</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">storageClassName</span><span class="pi">:</span> <span class="s">manual</span>
  <span class="na">accessModes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ReadWriteOnce</span>
  <span class="na">resources</span><span class="pi">:</span>
    <span class="na">requests</span><span class="pi">:</span>
      <span class="na">storage</span><span class="pi">:</span> <span class="s">1Gi</span>
</code></pre></div></div>

<p>我们可以先看 <code class="highlighter-rouge">PV</code> 资源，我们在 <code class="highlighter-rouge">/opt/nginx</code> 下定义了一个存储路径，并且这个 <code class="highlighter-rouge">PV</code> 的大小为 <code class="highlighter-rouge">2Gi</code>，他的存储类型是 <code class="highlighter-rouge">manual</code> 也就是我们手动维护存储在宿主机的类型，如果使用的是云厂商托管的 K8s，可以查看云厂商支持什么类型。</p>

<p>注意 <code class="highlighter-rouge">/opt/nginx</code> 路径必须存在，我们需要提前在服务器创建这个路径。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /opt/nginx
</code></pre></div></div>

<p>然后我们定义了一个 <code class="highlighter-rouge">PVC</code> 资源 ，并且存储类型也是 <code class="highlighter-rouge">manual</code>，并且需求是 <code class="highlighter-rouge">1Gi</code>，注意这里的需求要小于等于你定义的 <code class="highlighter-rouge">PV</code>，前面也提到它类似 <code class="highlighter-rouge">Pod</code> 会消耗 <code class="highlighter-rouge">Node</code> 的资源，类似我的服务跑多少 CPU 和内存就消耗多少服务器资源，这里就是我需要多少存储就消耗多少存储资源。</p>

<p>接下来就是修改 nginx 的 <code class="highlighter-rouge">Deployment</code> 资源，修改后的 <code class="highlighter-rouge">Deployment</code> 如下：</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">nginx-1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:latest</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/nginx/conf.d/default.conf</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">index.conf</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/opt/index.html</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
          <span class="na">subPath</span><span class="pi">:</span> <span class="s">index.html</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/log/nginx</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-pvc</span>
          
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-conf</span>
        <span class="pi">-</span> <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
            <span class="na">claimName</span><span class="pi">:</span> <span class="s">nginx-pvc</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-pvc</span>
</code></pre></div></div>

<p>修改完成后应用这个 <code class="highlighter-rouge">nginx.yaml</code> 文件：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ kubectl apply <span class="nt">-f</span> nginx.yaml
namespace/nginx-1 unchanged
configmap/nginx-conf configured
persistentvolume/nginx-pv created
persistentvolumeclaim/nginx-pvc created
deployment.apps/nginx configured
service/nginx unchanged
</code></pre></div></div>

<p>等待 nginx 部署完成后，通过浏览器访问 nginx 产生日志，然后就可以在宿主机的 <code class="highlighter-rouge">/opt/nginx/</code> 目录下看到日志。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>access.log 
10.42.0.0 - - <span class="o">[</span>31/Oct/2020:04:16:22 +0000] <span class="s2">"GET / HTTP/1.1"</span> 200 79 <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span> <span class="s2">"-"</span>
</code></pre></div></div>

<h2 id="总结">总结</h2>

<p>这篇文章主要讲的是如何为服务挂载配置文件和存储盘，但是在实际的生产环境中，使用存储盘的方式还是有差异的。下一篇文章会介绍如何通过，K8s Ingress 资源通过统一的端口和相应的路由配置向外网暴露服务。</p>


    <!-- 引入share模块 -->
    
  <div class="social-share-wrapper">
    <div class="social-share"></div>
  </div>


<!-- share.js -->
<script src="/assets/js/social-share.min.js"></script>
<script>
  socialShare('.social-share', {
    sites: [
      
        'qq'
        ,
        
      
        'wechat'
        ,
        
      
        'weibo'
        ,
        
      
        'twitter'
        ,
        
      
        'facebook'
        
      
    ],
    wechatQrcodeTitle: "分享到微信朋友圈",
    wechatQrcodeHelper: '期待在朋友圈见到这篇文章'
  });
</script>

</div>

<!-- 底部锚点 -->
<a id="htmldown" name="htmldown"></a>
<!-- 引入评论模块 -->



    <section class="post-footer-item comment">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MDA4OS8xNjYxNg=="></div>
    </section>

    <!-- 来必力City版安装代码 -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- City版安装代码已完成 -->





<!-- 引入goto模块 -->
<div class="bounceInRight animated go">
  <a title="顶部切换页面" class="gototop" href="#htmlup" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Top
    </div>
  </a>
  <a title="底部有livere评论哦" class="gotobottom" href="#htmldown" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Foot
    </div>
  </a>
</div>

<!-- 引入页面底部模块 -->
<footer id="bottom">
  <br>
  <span>Gzp的博客 ©
  
  
    2018
    -
  
  2020
  <a href="http://www.beian.miit.gov.cn">粤ICP备16038504号-1</a>
  <br>
  Powered by <a href="https://www.jekyll.com.cn/">Jekyll</a> | <a href="https://github.com/xukimseven/HardCandy-Jekyll">HardCandy-Jekyll</a></span>
</footer>


<!-- 引用wow.js的动画效果 -->
<script src="/assets/js/wow.js"></script>
<script>
var wow = new WOW({
  boxClass: 'wow',
  animateClass: 'animated',
  // offset: 600,
  mobile: true,
  live: true
})
wow.init()
</script>
<!-- 页面刷新回到顶部 -->
<script>
window.onbeforeunload = function () {
  //刷新后页面自动回到顶部
  document.documentElement.scrollTop = 0  //ie下
  document.body.scrollTop = 0  //非ie
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>

<link rel="stylesheet" href="/assets/css/bootstrap-toc.min.css">
<script src="/assets/js/bootstrap-toc.min.js"></script>
<script>
var navSelector = '#toc'
var $myNav = $(navSelector)

if (os.isAndroid || os.isPhone) {
  $myNav.parent().hide()
} else {
  $(function () {
    Toc.init($myNav)
    $('body').scrollspy({
      target: navSelector
    })
  })
}
</script>
<style type="text/css">

    nav[data-toggle=toc] .nav>li>a:focus,nav[data-toggle=toc] .nav>li>a:hover {
        padding-left: 19px;
        color: rgb(49, 106, 223);
        text-decoration: none;
        background-color: transparent;
        border-left: 1px solid rgb(49, 106, 223);
    }

    nav[data-toggle=toc] .nav-link.active, nav[data-toggle=toc] .nav-link.active:focus, nav[data-toggle=toc] .nav-link.active:hover {
        padding-left: 18px;
        font-weight: 700;
        color: rgb(49, 106, 223);
        background-color: transparent;
        border-left: 2px solid rgb(49, 106, 223);
    }

</style>
    <!-- Google Analytics -->
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-126817847-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-126817847-1');
</script>
</body>
</html>
