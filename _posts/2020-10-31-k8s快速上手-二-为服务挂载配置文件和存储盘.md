---
layout: post
title: K8s 快速上手 (二) 为服务挂载配置文件和存储盘
subtitle: 为部署在 K8s(k3s) 的服务挂载配置文件和存储盘
cover: /assets/uploads/kuberneteshero.jpg
date: 2020-10-31 10:46:45
top: false
tags: K8s入门教程 K8s上手教程 K8s
color: rgb(49, 106, 223)
---
上一篇文章 [「K8s 快速上手（一) 在云主机上部署我的服务」](https://elfgzp.cn/2020/10/25/k8s-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B(%E4%B8%80)%E5%9C%A8%E4%BA%91%E4%B8%BB%E6%9C%BA%E4%B8%8A%E9%83%A8%E7%BD%B2%E6%88%91%E7%9A%84%E6%9C%8D%E5%8A%A1.html) 介绍了如何快在云主机上快速的搭建 K3s，并且将一个服务部署到 K3s 中。  

这篇文章将介绍如何给部署的服务挂载配置文件、环境变量或存储盘。

## 为服务挂载配置文件和添加环境变量

我们同样以上一篇文章的 `nginx.yaml` 为例，上一篇的 `nginx.yaml` 文件内容如下：

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: nginx-1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: nginx-1
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
---
kind: Service
apiVersion: v1
metadata:
  name: nginx
  namespace: nginx-1
spec:
  selector:
    app: nginx
  type:  NodePort
  ports:
    - nodePort: 30080
      port: 8080
      protocol: TCP
      targetPort: 80
```

我们想将一个 nginx 配置文件挂载到 `/etc/conf.d` 目录下，我们这次需要使用到一个 K8s 资源 `ConfigMap`。  

使用 `ConfigMap` 能更加方便的管理配置文件并且也能以非常便捷的方式挂载到服务容器中。接下来我就来介绍一下如何使用。  

假设我有一个 `index.conf` 的配置文件和一个 `index.html` 的文件分别想挂载到 nginx 容器的 `/etc/conf.d/index.conf` 和 `/opt/index.html` 目录下。这里的 index.html 只是用于演示，正常的生产环境的前端发布还是将前端文件一起 build 在镜像中才是最佳实践。  

`index.conf` 的文件内容如下：

```conf
server {
  listen       80;
  server_name  _;

  location / {
    root    /opt/index.html;
    index  index.html index.htm;
    try_files $uri $uri/ /index.html;
  }
}
```

`index.html` 的文件内容如下：

```html
<!DOCTYPE html>
<html lang="en">
<body>
    <h1>Hello K8s</h1>
</body>
</html>
```

要挂载这两个文件，首先第一步我们需要创建一个 `ConfigMap` 资源，我们直接将这个资源也放在 `nginx.yaml` 文件中，在实际使用中可以按照需要拆分资源到不同的 `YAML` 文件。`ConfigMap` 资源的定义如下：

```yaml

```
